name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows-installers:
    runs-on: windows-latest
    name: Build Windows Installers
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install backend dependencies
      run: npm ci
    
    - name: Install frontend dependencies
      working-directory: ./client
      run: npm ci
    
    - name: Install NSIS
      run: |
        # NSIS ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        choco install nsis -y
        # ãƒ‘ã‚¹ã‚’æ›´æ–°
        $env:PATH += ";C:\Program Files (x86)\NSIS"
        echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Install NSIS plugins
      run: |
        # å¿…è¦ãªNSISãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        $nsisDir = "C:\Program Files (x86)\NSIS"
        $pluginsDir = "$nsisDir\Plugins\x86-unicode"
        $includeDir = "$nsisDir\Include"
        
        # inetc ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
        Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/c/c9/Inetc.zip" -OutFile "$env:TEMP\inetc.zip"
        Expand-Archive -Path "$env:TEMP\inetc.zip" -DestinationPath "$env:TEMP\inetc" -Force
        Copy-Item "$env:TEMP\inetc\Plugins\x86-unicode\inetc.dll" -Destination $pluginsDir -Force
        
        # nsisunz ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
        Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/5/5a/Nsisunz.zip" -OutFile "$env:TEMP\nsisunz.zip"
        Expand-Archive -Path "$env:TEMP\nsisunz.zip" -DestinationPath "$env:TEMP\nsisunz" -Force
        Copy-Item "$env:TEMP\nsisunz\Plugin\nsisunz.dll" -Destination $pluginsDir -Force
        Copy-Item "$env:TEMP\nsisunz\nsisunz.nsh" -Destination $includeDir -Force
        
        # GetSize ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
        Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/5/5e/GetSize.zip" -OutFile "$env:TEMP\getsize.zip"
        Expand-Archive -Path "$env:TEMP\getsize.zip" -DestinationPath "$env:TEMP\getsize" -Force
        Copy-Item "$env:TEMP\getsize\GetSize.nsh" -Destination $includeDir -Force
    
    - name: Build Electron installers
      run: npm run electron:build:all
    
    - name: Build NSIS auto-installer
      run: |
        cd installer
        makensis MyRadiko-Installer.nsi
        # Move installer to root directory for easier upload
        if (Test-Path "MyRadiko-Setup-v1.0.0.exe") {
          Move-Item "MyRadiko-Setup-v1.0.0.exe" "../MyRadiko-Setup-v1.0.0.exe"
          Write-Host "Auto-installer moved to root directory"
        }
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: MyRadiko ${{ github.ref_name }}
        body: |
          # MyRadiko ${{ github.ref_name }} - Windows Desktop Application
          
          radikoã®ç•ªçµ„ã‚’éŒ²éŸ³ãƒ»ç®¡ç†ã™ã‚‹ãŸã‚ã®Windowsç”¨ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
          
          ## ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          **ğŸŒŸ è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆæ¨å¥¨ï¼‰**: `MyRadiko-AutoInstaller-${{ github.ref_name }}.exe`
          - ğŸš€ **å®Œå…¨è‡ªå‹•åŒ–** - Node.jsã€Gitã€ä¾å­˜é–¢ä¿‚ã€ãƒ“ãƒ«ãƒ‰ã¾ã§å…¨è‡ªå‹•
          - ğŸ’¾ **å˜ä½“ãƒ•ã‚¡ã‚¤ãƒ«** - ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«1ã¤ã§å®Œå…¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          - ğŸ› ï¸ **æŠ€è¡“çŸ¥è­˜ä¸è¦** - å®Ÿè¡Œã™ã‚‹ã ã‘ã§ä½¿ç”¨å¯èƒ½
          - ğŸ—‘ï¸ **å®Œå…¨ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«** - ãƒ‡ãƒ¼ã‚¿ä¿æŒã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ã
          
          **æ¨™æº–**: NSISã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆ`MyRadiko-Setup-${{ github.ref_name }}.exe`ï¼‰
          - æ¨™æº–çš„ãªWindowsã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆäº‹å‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ï¼‰
          - ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè‡ªå‹•ä½œæˆ
          - ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²
          - ç°¡å˜ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          
          **ä¼æ¥­ç’°å¢ƒ**: MSIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆ`MyRadiko-${{ github.ref_name }}.msi`ï¼‰
          - ä¼æ¥­ç’°å¢ƒã§ã®ä¸€æ‹¬å±•é–‹ã«é©ç”¨
          - ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒªã‚·ãƒ¼ã§ã®ç®¡ç†ãŒå¯èƒ½
          
          **ãƒãƒ¼ã‚¿ãƒ–ãƒ«**: å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`MyRadiko-Portable-${{ github.ref_name }}.exe`ï¼‰
          - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦
          - USBãƒ¡ãƒ¢ãƒªãªã©ã§æŒã¡é‹ã³å¯èƒ½
          
          ## âœ¨ ä¸»è¦æ©Ÿèƒ½
          - ğŸ“» ç•ªçµ„è¡¨è¡¨ç¤ºï¼ˆ1é€±é–“å…ˆã¾ã§ï¼‰
          - ğŸµ éŒ²éŸ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
          - ğŸ“… äºˆç´„ç®¡ç†ï¼ˆç¹°ã‚Šè¿”ã—äºˆç´„å¯¾å¿œï¼‰
          - ğŸ§ ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ»å†ç”Ÿ
          - âš™ï¸ è©³ç´°è¨­å®šã‚·ã‚¹ãƒ†ãƒ 
          - ğŸ“‹ ãƒ­ã‚°ãƒ»å±¥æ­´ç®¡ç†
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ãŠå¥½ã¿ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          3. ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¾ãŸã¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰èµ·å‹•
          
          ## âš ï¸ æ³¨æ„äº‹é …
          - Windows 10/11 (64bit) å°‚ç”¨
          - radikoã®åˆ©ç”¨è¦ç´„ã«å¾“ã£ã¦ã”ä½¿ç”¨ãã ã•ã„
          - å€‹äººåˆ©ç”¨ç›®çš„ã®ã¿
        draft: false
        prerelease: false
    
    - name: Upload Auto-Build Installer
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MyRadiko-Setup-v1.0.0.exe
        asset_name: MyRadiko-AutoInstaller-${{ github.ref_name }}.exe
        asset_content_type: application/octet-stream
    
    - name: Upload NSIS Installer
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist-electron/MyRadiko Setup 1.0.0.exe
        asset_name: MyRadiko-Setup-${{ github.ref_name }}.exe
        asset_content_type: application/octet-stream
    
    - name: Upload MSI Installer
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist-electron/MyRadiko 1.0.0.msi
        asset_name: MyRadiko-${{ github.ref_name }}.msi
        asset_content_type: application/x-msi
    
    - name: Upload Portable Executable
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist-electron/MyRadiko 1.0.0.exe
        asset_name: MyRadiko-Portable-${{ github.ref_name }}.exe
        asset_content_type: application/octet-stream